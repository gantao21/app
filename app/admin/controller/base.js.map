{
    "version": 3,
    "sources": [
        "../../../src/admin/controller/base.js"
    ],
    "names": [
        "module",
        "exports",
        "think",
        "Controller",
        "__before",
        "user",
        "session",
        "redirect",
        "url",
        "ctx",
        "controller",
        "action",
        "console",
        "log",
        "is_admin",
        "isadmin",
        "auth",
        "service",
        "uid",
        "res",
        "check",
        "fail",
        "sidebar",
        "ids",
        "getRuleIds",
        "menus",
        "getSideBar",
        "assign",
        "in_array",
        "parseInt",
        "config",
        "data",
        "model",
        "alias",
        "join",
        "table",
        "as",
        "on",
        "where",
        "select",
        "forEach",
        "ruleIds",
        "item",
        "rule_ids",
        "split",
        "concat",
        "description",
        "ruleModel",
        "rules",
        "field",
        "id",
        "status",
        "is_show",
        "order",
        "group",
        "path",
        "length",
        "index",
        "child2",
        "push"
    ],
    "mappings": "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",
    "file": "../../../src/admin/controller/base.js",
    "sourcesContent": [
        "module.exports = class extends think.Controller {\n  async __before() {\n    this.user =await this.session('userInfo');\n  \t if(!this.user){\n  \t \t  \treturn this.redirect('public/login','admin');\n  \t}\n    /** 菜单当前状态\n     *  权限验证超级管理员\n     */\n    const url = this.ctx.controller+'/'+this.ctx.action;\n    console.log(url);\n\n    this.is_admin = this.isadmin(this.user);\n     // if (!this.is_admin) {\n      const auth = this.service('rbac', 'admin',this.user.uid);\n      const res = await auth.check(url);\n      console.log(res);\n      if (!res) {\n        return this.fail('没有权限');\n      }\n    // }\n    this.sidebar = await this.session('sidebar');\n\n    if(!this.sidebar){\n       const ids = await this.getRuleIds();\n       const menus = await this.getSideBar(ids);\n       console.log(menus);\n       await this.session('sidebar', menus);\n       this.sidebar = menus;\n    }\n    this.assign('description', await this.session('description'));\n    this.assign('sidebar',  this.sidebar);\n    this.assign('userInfo', this.user);\n\n\n\t}\n  /**\n     * 检查当前用户是否为管理员\n     * @param uid\n     * @returns {*|boolean}\n     */\n  async isadmin(uid) {\n    uid = uid || null;\n    return uid && (in_array(parseInt(uid), this.config('user_administrator')));\n  }\n  async getRuleIds(){\n     let  data= await think.model('auth_user_role').alias('a').join({\n      table: 'auth_role',\n      as: 'b',\n      on: ['role_id', 'id']\n    }).where({\n      'a.user_id': this.user.uid,\n      'b.status': 1\n    }).select();\n    let ids = [];\n    data.forEach(item => {\n      const ruleIds = (item.rule_ids || '').split(',');\n      ids = ids.concat(ruleIds);\n      this.session('description',item.description);\n    });\n\n    return ids;\n  }\n  async getSideBar(ids){\n      const ruleModel = think.model('auth_rule');\n      let rules = await ruleModel.field('id,pid,path,name,desc,icon,type,sort').where({id: ['IN', ids], status: 1,is_show:1}).order('pid,sort ASC').select();\n      let group = [];\n      // if (rules) {\n      //     // for (var i = 0; i < rules.length; i++) {\n      //       // let item = rules[i];\n      //       rules.forEach(item => {\n      //       if(item.pid == 0){\n      //             group[item.id] = item;\n      //             group[item.id]['child'] = [];\n      //       }else{\n      //             group[item.pid]['child'].push(item);\n\n      //       }\n      //     });\n      //     // }\n\n      // }\n      if (rules) {\n            rules.forEach(item => {\n            var path=(item.path).split(\"-\");\n            console.log('---------------'+path.length);\n            switch(path.length){\n              case 1:\n                    group[item['id']] = item;\n                    group[item['id']]['child'] = [];\n                    break;\n              case 2:\n                    let index= path[1];\n                    let  child2 = item;\n                    child2['child'] = [];\n                    group[index]['child'][item['id']]= child2;\n                    break;\n              case 3:\n                  console.log(group[path[1]]['child'][path[2]]['child']);\n                  group[path[1]]['child'][path[2]]['child'].push(item);\n                   break;\n             }\n          });\n      }\n        group.forEach(item => {\n            console.log(item['child']);\n        });\n      return group;\n  }\n};\n"
    ]
}