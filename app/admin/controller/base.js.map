{
    "version": 3,
    "sources": [
        "../../../src/admin/controller/base.js"
    ],
    "names": [
        "module",
        "exports",
        "think",
        "Controller",
        "__before",
        "console",
        "log",
        "ctx",
        "request",
        "host",
        "assign",
        "user",
        "session",
        "redirect",
        "url",
        "controller",
        "action",
        "is_admin",
        "isadmin",
        "requestPublic",
        "config",
        "includes",
        "auth",
        "service",
        "uid",
        "res",
        "check",
        "isAjax",
        "fail",
        "errorAction",
        "sidebar",
        "ids",
        "getRuleIds",
        "menus",
        "getSideBar",
        "data",
        "model",
        "alias",
        "join",
        "table",
        "as",
        "on",
        "where",
        "select",
        "forEach",
        "ruleIds",
        "item",
        "rule_ids",
        "split",
        "concat",
        "description",
        "ruleModel",
        "rules",
        "field",
        "id",
        "status",
        "is_show",
        "order",
        "group",
        "path",
        "length",
        "index",
        "child2",
        "push",
        "successAction",
        "message",
        "isJsonp",
        "jsonp",
        "display"
    ],
    "mappings": "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",
    "file": "../../../src/admin/controller/base.js",
    "sourcesContent": [
        "module.exports = class extends think.Controller {\n  async __before() {\n    console.log('request.host'+this.ctx.request.host);\n    this.assign('_PUBLIC_',  'http://'+this.ctx.request.host+'/public');\n\n    this.user =await this.session('userInfo');\n  \t if(!this.user){\n  \t \t  \treturn this.redirect('public/login','admin');\n  \t}\n    /** 菜单当前状态\n     *  权限验证超级管理员\n     */\n    const url = this.ctx.controller+'/'+this.ctx.action;\n    console.log(url);\n    \n    this.is_admin = this.isadmin(this.user);\n     if (!this.is_admin) {\n\n    let requestPublic = await this.config('request_public');\n    console.log(requestPublic);\n    if(!requestPublic.includes( 'admin/'+url)){\n      console.log('不存在');\n      const auth = this.service('rbac', 'admin',this.user.uid);\n      const res = await auth.check(url);\n      if (!res) {\n        if ( this.isAjax('post')) {\n          return this.fail('没有权限');\n        }else{\n          return this.errorAction('没有权限');\n       }\n      }\n    }else{\n      console.log('存在哟');\n    }\n  }\n    this.sidebar = await this.session('sidebar');\n\n    if(!this.sidebar){\n       const ids = await this.getRuleIds();\n       const menus = await this.getSideBar(ids);\n       console.log(menus);\n       await this.session('sidebar', menus);\n       this.sidebar = menus;\n    }\n    this.assign('description', await this.session('description'));\n    this.assign('sidebar',  this.sidebar);\n    this.assign('userInfo', this.user);\n\n\n\t}\n  /**\n     * 检查当前用户是否为管理员\n     * @param uid\n     * @returns {*|boolean}\n     */\n  async isadmin(uid) {\n    uid = uid || null;\n    return uid &&  this.config('user_administrator');\n  }\n  async getRuleIds(){\n     let  data= await think.model('auth_user_role').alias('a').join({\n      table: 'auth_role',\n      as: 'b',\n      on: ['role_id', 'id']\n    }).where({\n      'a.user_id': this.user.uid,\n      'b.status': 1\n    }).select();\n    let ids = [];\n    data.forEach(item => {\n      const ruleIds = (item.rule_ids || '').split(',');\n      ids = ids.concat(ruleIds);\n      this.session('description',item.description);\n    });\n\n    return ids;\n  }\n  async getSideBar(ids){\n      const ruleModel = think.model('auth_rule');\n      let rules = await ruleModel.field('id,pid,path,name,desc,icon,type,sort').where({id: ['IN', ids], status: 1,is_show:1}).order('pid,sort ASC').select();\n      let group = [];\n      if (rules) {\n            rules.forEach(item => {\n            var path=(item.path).split(\"-\");\n            console.log('---------------'+path.length);\n            switch(path.length){\n              case 1:\n                    group[item['id']] = item;\n                    group[item['id']]['child'] = [];\n                    break;\n              case 2:\n                    let index= path[1];\n                    let  child2 = item;\n                    child2['child'] = [];\n                    group[index]['child'][item['id']]= child2;\n                    break;\n              case 3:\n                  console.log(group[path[1]]['child'][path[2]]['child']);\n                  group[path[1]]['child'][path[2]]['child'].push(item);\n                   break;\n             }\n          });\n      }\n        group.forEach(item => {\n            console.log(item['child']);\n        });\n      return group;\n  }\n  async successAction(message = '成功信息！', status = 0) {\n    if (this.isJsonp()) {\n      return this.jsonp({\n        [this.config('errnoField')]: status,\n        [this.config('errmsgField ')]: message\n      });\n    } else if (this.isAjax()) {\n      return this.fail(status, message);\n    }\n    this.assign({\n      status: status,\n      message: message\n    });\n\n    return this.display('admin/success');\n  }\n  async errorAction(message = '错误信息！', status = 1000) {\n    if (this.isJsonp()) {\n      return this.jsonp({\n        [this.config('errnoField')]: status,\n        [this.config('errmsgField ')]: message\n      });\n    } else if (this.isAjax()) {\n      return this.fail(status, message);\n    }\n    this.assign({\n      status: status,\n      message: message\n    });\n\n    return this.display('admin/error');\n  }\n};\n"
    ]
}